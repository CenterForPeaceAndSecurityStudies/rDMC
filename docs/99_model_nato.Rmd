---
title: "08b Model NATO"
author: "J Andres Gannon"
date: "November 9, 2021"
output:
  bookdown::html_notebook2:
    fig_height: 8
    fig_width: 12
    number_sections: yes
    theme: flatly
    code_folding: hide
    toc: yes
    toc_depth: 5
    toc_float:
      collapsed: yes
  bookdown::pdf_document2:
    toc: yes
    toc_depth: '5'
    number_sections: yes
  bookdown::word_document:
    toc: no
    toc_depth: '5'
editor_options:
  chunk_output_type: inline
---

This document will re-examine the results of model 2 (dyadic division of labor) accounting for the presence of the NATO alliance. A question raised is whether NATO is driving the majority of the results, given we would expect the NATO alliance to be the best case scenario for allies having a division of labor given the high degree of interest alignment and hierarchy.

# Descriptive comparison
```{r}
# Pipe operators have trouble loading in-line so we load those first.
library(magrittr)
library(ggplot2)
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

# Load data
df <- readRDS(file = paste0(here::here(), '/data/df_fulldata_dyad.rds')) %>%
  dplyr::distinct()
```

## Existing pooled distribution of the DV
The distribution of the dependent variable generally, as shown in the existing paper and slides:
```{r}
# Distribution of DV
df %>%
  dplyr::filter(atop_defense == 1 |
                  atop_offense == 1 |
                  dca == 1) %>%
  ggplot(aes(x = dist_rinsp)) + 
  geom_histogram(color = "black",
                 fill = "grey",
                 size = 1) + 
  geom_vline(aes(xintercept = median(dist_rinsp)),
             color = "blue",
             linetype = "dashed",
             size = 1) +
  geom_text(aes(x = median(dist_rinsp) + 0.06, 
                label = "Median", 
                y = 2500), 
            colour = "blue", 
            size = 10) +
  scale_y_continuous(labels = scales::comma) +
  theme_bw() +
  labs(x = "Division of Labor \n (Low --- High)",
       y = "Number of Dyad-Years") +
  theme(text = element_text(size = 20))
```

## Alliance dyads by decade
The following figures show how many alliance dyads in each decade are composed of joint-NATO dyads. Alliance dyads are defined as those with either an offensive or defense alliance pact (ATOP) or a defense cooperation agreeement (DCA). Most alliance dyads in each decade are not joint-NATO dyads, although they do make up a larger share over time.

```{r}
# Separate by NATO membership
## Add NATO-dyad variable
nato <- rio::import(paste0(here::here(), "/inst/extdata/ipe_data_resource/3. Graham_Tucker_IPE_v2_0.RDATA")) %>%
  sjlabelled::remove_all_labels() %>%
  dplyr::mutate(nato = dplyr::if_else(year >= NATOwhen_MEM, 1, 0),
                nato = dplyr::if_else(is.na(nato), 0, nato)) %>%
  dplyr::select(year, ccode, nato)

nato <- nato %>%
  dplyr::rename(ccode1 = ccode)
df <- dplyr::left_join(df, nato) %>%
  dplyr::rename(nato1 = nato)

nato <- nato %>%
  dplyr::rename(ccode2 = ccode1)
df <- dplyr::left_join(df, nato) %>%
  dplyr::rename(nato2 = nato)

df <- df %>%
  dplyr::mutate(nato_joint = dplyr::if_else(nato1 == 1 & nato2 == 1, 1, 0),
                nato_joint = dplyr::if_else(is.na(nato_joint), 0, nato_joint),
                nato_joint = as.factor(nato_joint))

# Visualize
## Alliance dyads by decade
df %>%
  dplyr::filter(atop_defense == 1 |
                  atop_offense == 1 |
                  dca == 1) %>%
  ggplot(aes(x = nato_joint)) + 
  geom_bar() +
  scale_y_continuous(labels = scales::comma) +
  scale_x_discrete(labels = c("No", "Yes")) +
  labs(title = "Global alliance dyads that are NATO, by decade",
       x = "NATO-dyads",
       caption = "Smaller n in 2010 decade due to data ending at 2014") +
  theme_bw() +
  facet_wrap(~ decade) +
  theme(text = element_text(size = 20))
```

## New unpooled distribution of the DV
This figure shows the distribution of the dependent variable (division of labor) for joint-NATO dyads versus non-joint-NATO dyads. NATO dyads have a slightly higher division of labor score, in general, except for those alliance dyads with a perfect division of labor, which are overwhelmingly explained by imbalanced dyads involving a very resource-poor state or state with a minuscule military.
```{r}
## DV scores by NATO vs non-NATO
df %>%
  dplyr::filter(atop_defense == 1 |
                  atop_offense == 1 |
                  dca == 1) %>%
  ggplot(aes(x = dist_rinsp,
             group = nato_joint,
             fill = nato_joint)) + 
  geom_density(adjust = 1.5,
               alpha = 0.4) + 
  scale_y_continuous(labels = scales::comma) +
  scale_fill_discrete(labels = c("No", "Yes")) +
  theme_bw() +
  labs(x = "Division of Labor \n (Low --- High)",
       y = "Number of Alliance Dyad-Years") +
  guides(fill = guide_legend(title = "NATO-dyad")) +
  theme(text = element_text(size = 20),
        legend.position = "bottom")
```

# Models
I re-run the original model from the paper/presentation here alongside a second model that adds the NATO dummy. The results do not differ significantly, suggesting that even accounting for the existence of NATO, alliance-dyads with higher interest alignment and/or more  hierarchy are associated with a higher division of labor than those alliance dyads that don't.
```{r}
# Prep vars
df_m1 <- df %>%
  dplyr::filter(atop_defense == 1 |
                  atop_offense == 1 |
                  dca == 1) %>%
  dplyr::select(dist_rinsp,
                interestalign,
                alliance_instit,
                nato_joint,
                landcontig,
                gdpprop,
                milexprop,
                dyad,
                year,
                decade) %>%
  dplyr::mutate(landcontig = as.factor(landcontig),
                interestalign = scale(interestalign),
                alliance_instit = as.factor(alliance_instit),
                decade = as.factor(decade),
                year_sq = (year - 1970)^2,
                year_cube = (year - 1970)^3) %>%
  dplyr::rename(dv = dist_rinsp)

## Full model without NATO dummy
m2_spline <- lm(dv ~ 
                  interestalign + 
                  alliance_instit +
                  landcontig +
                  gdpprop +
                  milexprop +
                  year +
                  year_sq +
                  year_cube,
                data = df_m1)

m2_splinecse <- lmtest::coeftest(m2_spline, vcov = sandwich::vcovCL(m2_spline, factor(df_m1$dyad)))

## Full model with NATO dummy
m3_spline <- lm(dv ~ 
                  interestalign + 
                  alliance_instit +
                  nato_joint +
                  landcontig +
                  gdpprop +
                  milexprop +
                  year +
                  year_sq +
                  year_cube,
                data = df_m1)

m3_splinecse <- lmtest::coeftest(m3_spline, vcov = sandwich::vcovCL(m3_spline, factor(df_m1$dyad)))
```

```{r, results='asis', echo = T}
# Make list of models
models <- list(m2_splinecse, m3_splinecse)

# Display
texreg::htmlreg(models,
               omit.coef = "decade|Intercept|year|alliance_instit1",
               custom.coef.names = c("Interest Alignment",
                                     "Hierarchy",
                                     "Contiguity",
                                     "GDP ratio",
                                     "Mil Spending ratio",
                                     "NATO dyad"),
               custom.note = "\\item %stars. All models include country-clustered standard errors and scaled cubic polynomials (not shown),",
               label = "table:model",
               float.pos = "h",
               caption = "OLS models",
               use.packages = FALSE,
               threeparttable = TRUE)
```
