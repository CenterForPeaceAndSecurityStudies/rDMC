---
title: "04 Dependent Variable - Division of Labor"
author: "J Andres Gannon"
date: "November 21, 2019"
output:
  html_document:
    toc: yes
  html_notebook:
    toc: yes
    toc_float: yes
editor_options:
  chunk_output_type: inline
---
<style>
    body .main-container {
        max-width: 100%;
    }
</style>

# Prep
Pipe operators have trouble loading in-line so we load those first.
```{r}
library(magrittr)
library(ggplot2)
```

# Load and clean data
## Country-year IISS data
We start by loading the cleaned IISS data. This dataframe contains information about the count of military units at the country-year level.
```{r}
# Load data
df <- readRDS(file = paste0(here::here(), '/data/01z_rDMC_wide.rds'))
  
# Keep a separate df of just the ID vars since ccode and cname were added later and are not included in the function
id_vars <- df %>%
  dplyr::select(year, country)

# Create vector of countries and years
df_year <- unique(df$year)
df_country <- unique(df$country)
```

## Country year alliance data
We want to get columns for each alliance that are dummy variables indicating whether that country was in that alliance
```{r}
# Load
atop_member <- rio::import(paste0(here::here(), "/inst/extdata/ATOP/atop5_0m.csv"))

# Subset
atop <- atop_member %>%
  dplyr::select(atopid, member, yrent, yrexit, ineffect, defense) %>%
  dplyr::filter(yrexit > 1970 |
                  yrexit == 0) %>%
  dplyr::filter(defense == 1) %>%
  dplyr::select(- defense) %>%
  dplyr::rename(ccode = member)

# Create dataframe of COW country-years post-1970
states <- read.csv(paste0(here::here(), "/inst/extdata/COW/","system2016.csv")) %>%
  dplyr::filter(year >= 1970) %>%
  dplyr::select(-version)

# Merge them together so we have all active alliances for each country-year
atop_list <- dplyr::left_join(states, atop) %>%
  dplyr::mutate(year = as.numeric(year),
                yrent = as.numeric(yrent),
                yrexit = as.numeric(yrexit)) %>%
  dplyr::mutate(yrexit = dplyr::if_else(ineffect == 1, 2015, yrexit)) %>%
  dplyr::filter(year >= 1970 &
                  year <= 2014) %>%
  dplyr::mutate(active = ifelse(yrent <= year &
                                  yrexit >= year, 1, 0)) %>%
  dplyr::select(year, stateabb, ccode, atopid, active) %>%
  dplyr::filter(active == 1) %>%
  dplyr::distinct() %>%
  dplyr::mutate(atopid = paste("atopid", atopid, sep = "_")) %>%
  dplyr::group_by(year, stateabb, ccode) %>%
  tidyr::spread(key = atopid,
                value = active,
                fill = "0")
```

## Merge and clean
```{r}
df <- dplyr::left_join(df, atop_list) %>%
  dplyr::mutate_at(vars(dplyr::starts_with("atopid_")), ~tidyr::replace_na(. , 0)) %>%
  tidyr::pivot_longer(cols = dplyr::starts_with("atopid_"),
                      names_to = "atop_alliance",
                      values_to = "member") %>%
  dplyr::relocate(atop_alliance, member, .after = ccode) %>%
  dplyr::mutate(atop_alliance = stringr::str_remove(atop_alliance, "_")) %>%
  dplyr::filter(member == 1) %>%
  dplyr::select(-member) %>%
  tidyr::unite(col = "allyyear",
               atop_alliance, year,
               remove = FALSE) %>%
  dplyr::group_by(allyyear) %>%
  dplyr::add_count(name = "allies") %>%
  dplyr::ungroup() %>%
  dplyr::filter(allies > 1) %>%
  dplyr::select(-allies) %>%
  dplyr::mutate(tek_count = dplyr::select(., 'air defence_air to air missiles':'unmanned aerial vehicles_transport') %>%
                  rowSums(na.rm = TRUE)) %>%
  dplyr::group_by(allyyear) %>%
  dplyr::mutate(tek_count_ally = sum(tek_count, na.rm = TRUE)) %>%
  dplyr::filter(tek_count_ally > 0) %>%
  dplyr::select(-tek_count, -tek_count_ally) %>%
  dplyr::ungroup()

df_allyyear <- unique(df$allyyear)

# list <- as.data.frame(df_allyyear)
```

# Select data
We can make calculations at the network level which means for every state. But that is selecting on the DV because we're only comparing alliance clusters with one another. Which may be ok, but need to be clear about that.

# Alliance-level DoL measures

## Overall Alliance complementarity (H2fun)
This calculates complementary specialization of an alliance network by looking at the extent to which teks each states possess deviate from those we would expect given the tek totals
Higher H2 values means more complementary specialization within the alliance network

### Generalized
```{r}
# initial empty list
my_list <- list()
  
# define function
func <- function(df_allyyear){
  
  test <- df %>% 
    dplyr::filter(allyyear == df_allyyear) %>%
    tidyr::unite(col = "rowname", allyyear, country, remove = TRUE) %>%
    tibble::column_to_rownames(var = "rowname") %>%
    dplyr::select(-c(year, stateabb, ccode, atop_alliance)) %>%
    replace(is.na(.), 0) %>%
    janitor::adorn_percentages(denominator = "col",
                               na.rm = TRUE) %>%
    replace(is.na(.), 0)

  scores <- bipartite::networklevel(test,
                                    index = "H2",
                                    level = "lower") %>%
    as.data.frame() %>%
    dplyr::rename('h2' = '.')
  
  # save each alliance-year as a dataframe in a list
  my_list[paste(df_allyyear)] <<- list(scores)
}

# loop through all alliance-years
for(i in df_allyyear){
  func(df_allyyear = i)
}

# bind nested datasets into a complete dataframe
d_by_allyyear <- do.call(rbind.data.frame, my_list)

# Rename as the method used
h2 <- as.data.frame(d_by_allyyear) %>%
  tibble::rownames_to_column(var = "id") %>%
  tidyr::separate(id, into = c("atopid", "year"), sep = "_") %>%
  dplyr::mutate(atopid = gsub("[^0-9.-]", "", atopid)) %>%
  dplyr::mutate(year = as.numeric(year))
```

### Clean
Add some temporarily useful variables here at the alliance level
```{r}
atopa <- rio::import(paste0(here::here(), "/inst/extdata/ATOP/atop5_0a.csv")) %>%
  dplyr::select(atopid, bilat) %>%
  dplyr::mutate(atopid = as.character(atopid))

h2 <- dplyr::left_join(h2, atopa)
```

### Visualize
```{r}
h2 <- readRDS(file = paste0(here::here(), '/data/02b_DV_dol-alliance.rds'))

# Density plot
h2 %>%
  ggplot(aes(x = h2)) + 
  geom_density() + 
  theme_minimal()

# By alliance for a single year
h2 %>%
  dplyr::mutate(bilat = as.factor(bilat)) %>%
  dplyr::filter(year == 2014) %>%
  ggplot(aes(x = h2,
             y = reorder(atopid, h2),
             color = bilat)) + 
  geom_point() + 
  stat_smooth() +
  theme_minimal() +
  labs(title = "Distribution of Division of Labor Scores within Alliances",
       x = "Division of Labor",
       y = "Alliance")

# Comparison of US alliances over time
h2 %>%
  dplyr::mutate(atopid = dplyr::recode(atopid, 
                                       "3075" = "Rio Treaty",
                                       "3150" = "OAS",
                                       "3180" = "NATO",
                                       "3210" = "US-Philippines",
                                       "3215" = "ANZUS",
                                       "3240" = "US-ROK",
                                       "3260" = "US-Thailand",
                                       "3355" = "US-Pakistan",
                                       "3360" = "US-Turkey",
                                       "3375" = "US-Japan")) %>%
  ggplot(aes(x = year,
             y = h2,
             color = atopid)) +
  geom_line() +
  geom_smooth() +
  gghighlight::gghighlight(atopid %in% c("Rio Treaty",
                                         "OAS",
                                         "NATO",
                                         "ANZUS",
                                         "US-Philippines",
                                         "US-ROK",
                                         "US-Thailand",
                                         "US-Pakistan",
                                         "US-Turkey",
                                         "US-Japan"),
                           use_direct_label = TRUE) +
  theme_minimal() +
  facet_wrap(~bilat) +
  labs(title = "Division of Labor of Military Capabilities within Alliances",
       caption = "US alliances highlighted",
       x = "Year",
       y = "Division of Labor") +
  theme(legend.position = 'none')
```

### Toy example
```{r}
# Create dummy test set of NATO 2010
test_nato_raw <- df %>%
  dplyr::filter(allyyear == "atopid3180_2010") %>%
  dplyr::select(-c(allyyear, year, stateabb, ccode, atop_alliance)) %>%
  dplyr::select(!dplyr::starts_with("atopid_")) %>%
  dplyr::mutate(country = stringr::str_to_title(country),
                country = dplyr::recode(country,
                                        "Us" = "US")) %>%
  tibble::column_to_rownames(var = "country") %>%
  replace(is.na(.), 0) %>%
  dplyr::select_if(colSums(.) != 0)

test_nato_ratio <- df %>%
  dplyr::filter(allyyear == "atopid3180_2010") %>%
  dplyr::select(-c(allyyear, year, stateabb, ccode, atop_alliance)) %>%
  dplyr::mutate(country = stringr::str_to_title(country),
                country = dplyr::recode(country,
                                        "Us" = "US")) %>%
  tibble::column_to_rownames(var = "country") %>%
  replace(is.na(.), 0) %>%
  dplyr::select_if(colSums(.) != 0) %>%
  janitor::adorn_percentages(denominator = "col")

# Some extra stats
test_nato_ratio %>%
  bipartite::grouplevel(level = "lower",
                        weighted = TRUE)

# Viz as matrix
test_nato_ratio %>%
  bipartite::visweb(type = "diagonal",
                    labsize = 3)

# Viz as sankey
test_nato_raw %>%
  bipartite::plotweb(labsize = 2,
                     col.interaction = "red",
                     bor.col.interaction = "gray50",
                     y.lim = c(-0.1, 3),
                     text.rot = 90)


### East Asia example
df %>%
  dplyr::filter(year == 2010 &
                  stateabb %in% c('USA',
                                 'JPN',
                                 'ROK',
                                 'TAW')) %>%
  dplyr::select(-c(year, country, ccode)) %>%
  dplyr::distinct() %>%
  tibble::column_to_rownames(var = "stateabb") %>%
  replace(is.na(.), 0) %>%
  dplyr::select_if(colSums(.) != 0) %>%
  janitor::adorn_percentages(denominator = "col") %>%
  bipartite::visweb(type = "diagonal",
                    labsize = 3,
                    plotsize = 13)
```

## Within-alliance countries (CZ)
Modularity is a way of thinking about who has an important role in an alliance network. It's a form of specialization in that it describes countries that have similar roles, where roles are determined by the military capabilities they possess. The interaction matrices within each module are similar, indicating those countries do similar things.

A module is a group of states within an alliance that are more closely connected to each other than the countries in other modules. A way of thinking about modules is that countries in the same module are performing the same role (Guimera 2005)

***Null model is important because it's what allows you to compare alliances of different sizes. You compare the real alliance to null simulations of that same matrix and those figures can be compared with one another (Vazquez & Aizen, 2003; Bluthgen et al., 2008; Dormann et al., 2009)

C score is a standardized measure that refers to among-module role (meaning the entire alliance network). If all your teks are within your module, your C score is 0. If your teks are evenly distributed across all modules, your C score is 1
Z score is a standardized measure that refers to within module role (meaning within its module within the alliance)

Types of countries (Olesen et al 2007 from biology)
peripheral country = low C and low Z. It's a specialist who really only does one thing
connector country = high C and low Z. It glues modules together and is important for network coherence
module hub country = low C and high Z. It is important to its own module
network hub country = high C and high Z. It is important to its module and overall

```{r}
# Calculate cut off thresholds for cz scores
## Computer scores
modules <- test_nato_raw %>%
  bipartite::computeModules() %>%
  bipartite::czvalues(weighted = TRUE,
                      level = "lower")

## run null models to see what it would be in 1000 random simulations
nulls <- bipartite::nullmodel(test_nato_raw,
                              N = 1000)
null.mod.list <- sapply(nulls, bipartite::computeModules)
null.cz <- lapply(null.mod.list, bipartite::czvalues)

## computer 95% for c values across all species in nulls
null.cs <- sapply(null.cz, function(x) x$c)
## identify threshold for uncommonly high c-values
cval <- 1 - as.numeric(quantile(null.cs,
                            0.95))

## repeat the last 2 steps for z-values
null.zs <- sapply(null.cz, function(x) x$z)
zval <- as.numeric(quantile(null.zs,
                            0.95,
                            na.rm = TRUE))

# Plot with those cut offs
test_nato_raw %>%
  bipartite::computeModules() %>%
  bipartite::czvalues(weighted = TRUE,
                      level = "lower") %>%
  as.data.frame() %>%
  dplyr::mutate(c = 1 - c) %>%
  tibble::rownames_to_column(var = "country") %>%
  ggplot(aes(x = c,
             y = z,
             label = country)) +
  geom_point(size = 4) +
  ggrepel::geom_text_repel(size = 10) +
  geom_vline(xintercept = cval,
             color = "red",
             size = 1) +
  geom_hline(yintercept = zval,
             color = "red",
             size = 1) +
  labs(x = "Country Specialization",
       y = "Country Uniqueness",
       caption = "Red lines indicate critical values calculated as 95% quantiles from 1,000 within-alliance simulations.") +
  theme_minimal(base_size = 30)

ggsave(file = paste0(here::here(), "/paper/figures/dol_scores/czvalues_nato_2010.png"), width = 16, height = 12, units = "in")

# Plot modules
test_nato_raw %>%
  bipartite::computeModules() %>%
  bipartite::plotModuleWeb(rank = TRUE,
                           weighted = TRUE)
```


# Save
```{r}
saveRDS(h2, paste0(here::here(), "/data/","02b_DV_dol-alliance.rds"))
```
