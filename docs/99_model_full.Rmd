---
title: "05b Model Full"
author: "J Andres Gannon"
date: "April 23, 2020"
output:
  html_document:
    toc: yes
  html_notebook:
    toc: yes
    toc_float: yes
editor_options:
  chunk_output_type: inline
---

This document will create the model examining the explanatory power of alliance variables in explaining specialization.

# Prep
Pipe operators have trouble loading in-line so we load those first.
```{r}
library(magrittr)
library(ggplot2)
```

# Load and clean data
## Load
We start by loading the cleaned IISS data. This dataframe contains information about the count of military units at the country-year level.
```{r}
# Load data
df <- readRDS(file = paste0(here::here(), '/data/df_fulldata_dyad.rds')) %>%
  dplyr::distinct()

sd(df$dist_rinsp)
sd(df$interestalign, na.rm = TRUE)

summary(df$dist_rinsp)
```

## Summarize
Show distributions of the variables
```{r}
# Distribution of DV
df %>%
  ggplot(aes(x = dist_rinsp)) + 
  geom_density() + 
  theme_minimal()

g <- df %>%
  dplyr::filter(atop_defense == 1 |
                  atop_offense == 1 |
                  dca == 1) %>%
  ggplot(aes(x = dist_rinsp)) + 
  geom_histogram(color = "black",
                 fill = "grey",
                 size = 1) + 
  geom_vline(aes(xintercept = mean(dist_rinsp)),
             color = "blue",
             linetype = "dashed",
             size = 1) +
  geom_vline(aes(xintercept = mean(dist_rinsp) + sd(dist_rinsp)),
             color = "blue",
             linetype = "dotted",
             size = 1) +
  geom_vline(aes(xintercept = mean(dist_rinsp) - sd(dist_rinsp)),
             color = "blue",
             linetype = "dotted",
             size = 1) +
  geom_text(aes(x = mean(dist_rinsp) + 0.05, 
                label = "Mean", 
                y = 2500), 
            colour = "blue", 
            size = 10) +
  geom_text(aes(x = mean(dist_rinsp) + sd(dist_rinsp) + 0.05, 
                label = "+1 SD", 
                y = 2300), 
            colour = "blue", 
            size = 8) +
  geom_text(aes(x = mean(dist_rinsp) - sd(dist_rinsp) - 0.05, 
                label = "-1 SD", 
                y = 2300), 
            colour = "blue", 
            size = 8) +
  scale_y_continuous(labels = scales::comma) +
  theme_bw() +
  labs(x = "Division of Labor \n (Low --- High)",
       y = "Number of Dyad-Years") +
  theme(text = element_text(size = 36))
g
ggsave(g, file = paste0(here::here(),"/paper/figures/dol_scores/dol_histogram.png"), width = 16, height = 12, units = "in")
```

# Models
## M1 Interest alignment and Vertical integration
This is conditional on states being in an alliance...but what do I mean by alliance? For now, you're in an alliance if atop offense or defense or have a dca

### Prep vars
```{r}
names(df)

df_m1 <- df %>%
  dplyr::filter(atop_defense == 1 |
                  atop_offense == 1 |
                  dca == 1) %>%
  dplyr::select(dist_rinsp,
                interestalign,
                alliance_instit,
                landcontig,
                gdpprop,
                milexprop,
                dyad,
                year,
                decade) %>%
  dplyr::mutate(landcontig = as.factor(landcontig),
#                interestalign = scale(interestalign),
#                alliance_instit = as.factor(alliance_instit),
                decade = as.factor(decade),
                year_sq = (year - 1970)^2,
                year_cube = (year - 1970)^3) %>%
  dplyr::rename(dv = dist_rinsp)

naniar::gg_miss_var(df_m1,
                    facet = decade)
```

### Bivariate
```{r}
# Bivariate OLS
m1 <- lm(dv ~
           interestalign + 
           alliance_instit,
         data = df_m1)
summary(m1)

# Dyad SE
m1_cse <- lmtest::coeftest(m1, vcov = sandwich::vcovCL(m1, factor(df_m1$dyad)))
m1_cse
```

## M2 Full model
### Multi
```{r}
m2 <- lm(dv ~
           interestalign + 
           alliance_instit +
           landcontig +
           gdpprop +
           milexprop,
         data = df_m1)
summary(m2)
```

### Multi + decade FE
```{r}
# Decade FE
m2_dfe <- lm(dv ~ 
               interestalign + 
               alliance_instit +
               landcontig +
               gdpprop +
               milexprop +
               as.factor(decade),
         data = df_m1)
summary(m2_dfe)
```

### Multi + dyad SE
```{r}
m2_cse <- lmtest::coeftest(m2, vcov = sandwich::vcovCL(m2, factor(df_m1$dyad)))
m2_cse
```

### Multi + splines
```{r}
m2_spline <- lm(dv ~ 
                  interestalign + 
                  alliance_instit +
#                  interestalign*alliance_instit +
                  landcontig +
                  gdpprop +
                  milexprop +
                  year +
                  year_sq +
                  year_cube,
                data = df_m1)
summary(m2_spline)
```

### Multi + decade FE + dyad SE
```{r}
m2_dfecse <- lmtest::coeftest(m2_dfe, vcov = sandwich::vcovCL(m2_dfe, factor(df_m1$dyad)))
m2_dfecse
```

### Multi + splines + dyad SE
```{r}
m2_splinecse <- lmtest::coeftest(m2_spline, vcov = sandwich::vcovCL(m2_spline, factor(df_m1$dyad)))
m2_splinecse
```

## M3
### Interaction
```{r}
df_m3 <- df %>%
  dplyr::filter(atop_defense == 1 |
                  atop_offense == 1 |
                  dca == 1) %>%
  dplyr::select(dist_rinsp,
                interestalign,
                alliance_instit,
                landcontig,
                gdpprop,
                milexprop,
                dyad,
                year,
                decade) %>%
  dplyr::mutate(landcontig = as.factor(landcontig),
                decade = as.factor(decade),
                year_sq = (year - 1970)^2,
                year_cube = (year - 1970)^3) %>%
  dplyr::rename(dv = dist_rinsp)

m3_spline <- lm(dv ~ 
                  interestalign + 
                  alliance_instit +
                  interestalign*alliance_instit +
                  landcontig +
                  gdpprop +
                  milexprop +
                  year +
                  year_sq +
                  year_cube,
                data = df_m3)
summary(m3_spline)

m3_splinecse <- lmtest::coeftest(m3_spline, vcov = sandwich::vcovCL(m3_spline, factor(df_m3$dyad)))
m3_splinecse

```

# Results
## Table
```{r}
# Make list of models
models <- list(m1_cse,
               m2_cse, m2_dfecse, m2_splinecse,
               m3_splinecse)

texreg::texreg(models,
               omit.coef = "decade|Intercept|year",
               custom.coef.names = c("Interest Alignment",
                                     "Vertical Integration",
                                     "Contiguity",
                                     "GDP ratio",
                                     "Mil Spending ratio",
                                     "Interest Align. * Vertical Integ."),
               groups = (list("Independent Variables" = 1:2,
                              "Controls" = 3:5,
                              "Interaction Term" = 6)),
               custom.gof.rows = list("Decade FE" = c("No", "No", "Yes", "No", "No"),
                                      "Cubic polynomials" = c("No", "No", "No", "Yes", "Yes")),
               custom.note = "\\item %stars \\\\\n All models include country-clustered standard errors. \\\\\n Coefficients for decade and scaled cubic polynomials not shown.",
               label = "table:model",
               float.pos = "h",
               caption = "OLS models",
               use.packages = FALSE,
               threeparttable = TRUE,
               file = paste0(here::here(), "/paper/figures/model_results/","paper3_models.tex"))
```

## Regression Plot
```{r}
models <- list(m1_cse,
               m2_cse, m2_spline, m2_splinecse)

# Modelsummary
coefs <- c('interestalign' = 'Interest Alignment',
           'alliance_instit' = 'Vertical Integration',
           'landcontig1' = 'Contiguity',
           'gdpprop' = 'GDP Ratio',
           'milexprop' = 'Mil Spend Ratio')

coefplot <- modelsummary::modelplot(models,
                                    coef_map = coefs) +
  labs(title = 'Alliance Variable Results',
       x = 'Coefficients',
       y = 'Independent Variables',
       caption = 'Variables for decade and scaled year polynomials not shown.')

coefplot

ggsave(coefplot, file = paste0(here::here(),"/paper/figures/model_results/paper3_coefplot.png"), width = 16, height = 12, units = "in")

# sjPlot
models <- list(m1, m2_dfe, m2_spline)

evplot <- sjPlot::plot_models(models,
                    rm.terms = c("year",
                                 "year_sq",
                                 "year_cube",
                                 "as.factor(decade)1980",
                                 "as.factor(decade)1990",
                                 "as.factor(decade)2000",
                                 "as.factor(decade)2010"),
                    show.values = TRUE,
                    p.threshold = c(0.1, 0.05, 0.01),
                    digits = 3,
                    std.est = "std",
                    vline.color = "black",
                    axis.labels = c("Military Spending Ratio",
                                    "GDP Ratio",
                                    "Contiguity",
                                    "Vertical Integration",
                                    "Interest Alignment"),
                    m.labels = c("EVs only",
                                 "Decade FE",
                                 "Scaled Year Polynomials"),
                    show.legend = TRUE,
                    legend.title = "Model",
                    title = "Model Results") +
  ylim(-0.5, 0.25) +
  theme_minimal() +
  labs(caption = "All models include dyad-clustered standard errors, Coefficients standardized.")

evplot

sjPlot::save_plot(fig = evplot, 
                  filename = paste0(here::here(),"/paper/figures/model_results/dol.png"),
                  width = 18,
                  height = 18)
```

## Effects plots
```{r}
df_m1 %>%
  dplyr::select(dv, interestalign, alliance_instit, landcontig, gdpprop, milexprop) %>%
  DT::datatable(filter = "top")

hist(df_m1$interestalign)
hist(df_m1$alliance_instit)

# Interest alignment
g <- jtools::effect_plot(m2_spline,
                    pred = interestalign,
                    interval = TRUE,
                    main.title = "Marginal Effect of Interest Alignment",
                    x.label = "Interest Alignment",
                    y.label = "Division of Labor") +
  theme(text = element_text(size = 20),
        plot.title = element_text(size = 22))
g
ggsave(g, file = paste0(here::here(),"/paper/figures/model_results/paper3_effectplot_interestalign.png"), height = 8, width = 8, units = "in")

# Vertical integration
g <- jtools::effect_plot(m2_spline,
                    pred = alliance_instit,
                    interval = TRUE,
                    force.cat = TRUE,
                    pred.labels = c('Low', 'Moderate', 'High'),
                    main.title = "Marginal Effect of Alliance Institutionalization",
                    x.label = "Alliance Institutionalization",
                    y.label = "Division of Labor") +
  theme(text = element_text(size = 28),
        plot.title = element_text(size = 26),
        legend.position = "bottom")
g
ggsave(g, file = paste0(here::here(),"/paper/figures/model_results/paper3_effectplot_verticalinteg.png"), height = 8, width = 10, units = "in")

plot(effects::allEffects(m2_spline))

g <- interactions::interact_plot(m2_spline,
                            pred = interestalign,
                            modx = alliance_instit,
                            interval = TRUE,
                            modx.values = c("0", "2"),
                            modx.labels = c("Low", "High"),
                            x.label = "Interest Alignment",
                            y.label = "Division of Labor",
                            main.title = "Partial Residuals for Interest Alignment-Hierarchy",
                            legend.main = "Hierarchy") +
  xlim(-2, 1) +
  ylim(0.42, 0.58) +
  theme(text = element_text(size = 28),
        plot.title = element_text(size = 26),
        legend.position = "bottom") +
  labs(caption = "X-axis scaled by SD from mean.")
g
ggsave(g, file = paste0(here::here(),"/paper/figures/model_results/paper3_effectplot_EVs.png"), height = 8, width = 10, units = "in")
```

## Examples
### US-Japan
```{r}
g <- df %>%
  dplyr::filter(dyad == "USA_JPN",
                year > 1983) %>%
  dplyr::select(year, dist_rinsp, interestalign, alliance_instit) %>%
  ggplot(aes(x = year, y = dist_rinsp)) +
  geom_point() +
  geom_smooth() +
  theme_minimal() +
  labs(title = "Complementarity of US-Japan Military Capabilities",
       x = "Year",
       y = "Division of Labor") +
  theme(text = element_text(size = 24))

g

g <- ggsave(g, file = paste0(here::here(),"/paper/figures/dol_scores/us-japan.png"), height = 8, width = 16, units = "in")
```

### US-Albania and US-Georgia
```{r}
g <- df %>%
  dplyr::filter(dyad == "USA_ALB" | dyad == "USA_GRG",
                year > 1993) %>%
  dplyr::select(year, stateb, dist_rinsp, interestalign, alliance_instit) %>%
  dplyr::mutate(stateb = stringr::str_to_title(stateb)) %>%
  ggplot(aes(x = year, 
             y = dist_rinsp, 
             color = stateb)) +
  geom_point() +
  geom_smooth(method = "loess") +
  geom_vline(aes(xintercept = 2009),
             linetype = 'dashed',
             colour = "darkmagenta") +
  geom_text(aes(x = 2010, 
                label = "Joins\nNATO", 
                y = 0.85), 
            colour = "darkmagenta", 
            size = 6) +
  geom_vline(aes(xintercept = 1999),
             linetype = 'dashed',
             colour = "darkmagenta") +
  geom_text(aes(x = 2000, 
                label = "Joins\nMAP", 
                y = 0.85), 
            colour = "darkmagenta", 
            size = 6) +
  geom_vline(aes(xintercept = 2008),
             linetype = 'dashed',
             color = "forestgreen") +
  geom_text(aes(x = 2007, 
                label = "Denied\nNATO", 
                y = 0.425), 
            colour = "forestgreen", 
            size = 6) +
  geom_vline(aes(xintercept = 1994),
             linetype = 'dashed',
             color = "black") +
  geom_text(aes(x = 1995, 
                label = "Joins\nPfP", 
                y = 0.85), 
            colour = "darkmagenta", 
            size = 6) +
  geom_text(aes(x = 1995, 
                label = "Joins\nPfP", 
                y = 0.425), 
            colour = "forestgreen", 
            size = 6) +
  scale_color_manual(breaks = c("Albania", "Georgia"),
                     values = c("darkmagenta", "forestgreen")) +
  theme_bw() +
  scale_x_continuous(breaks = seq(1994, 2014, 5)) +
  labs(x = "Year",
       y = "Division of Labor with US",
       caption = "Smoothed loess moving average with shaded 95% CI") +
  theme(text = element_text(size = 28),
        legend.position = "bottom",
        legend.title = element_blank())

g

ggsave(g, file = paste0(here::here(), "/paper/figures/dol_scores/albania_georgia.png"), width = 12, height = 8)
```
