---
title: "Defense Pacts"
author: "J Andres Gannon"
date: "May 24, 2020"
output:
  html_document:
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
  html_notebook:
    toc: yes
    toc_float: yes
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(magrittr)
```

We want to know how long each state has been in each alliance and then create variables for longest alliance length and average alliance length for every country-year

# Load member data
```{r}
atop_member <- rio::import(paste0(here::here(), "/inst/extdata/ATOP/atop5_0m.csv"))
```

# Subset
```{r}
atop <- atop_member %>%
  dplyr::select(atopid, member, yrent, yrexit, ineffect, defense) %>%
  dplyr::filter(yrexit > 1970 |
                  yrexit == 0) %>%
  dplyr::filter(defense == 1) %>%
  dplyr::select(- defense) %>%
  dplyr::rename(ccode = member)
```

# Create dataframe of COW country-years post-1970
```{r}
states <- read.csv(paste0(here::here(), "/inst/extdata/COW/","system2016.csv")) %>%
  dplyr::filter(year >= 1970) %>%
  dplyr::select(-version)
```

# Merge them together
Merge together so we have all active alliances for each country-year, then we can calculate the duration of each alliance, and from that each country-year now has variables for their longest alliance and their average alliance duration
```{r}
df <- dplyr::left_join(states, atop) %>%
  dplyr::mutate(year = as.numeric(year),
                yrent = as.numeric(yrent),
                yrexit = as.numeric(yrexit)) %>%
  dplyr::mutate(yrexit = dplyr::if_else(ineffect == 1, 2015, yrexit)) %>%
  dplyr::filter(year < yrexit) %>%
  dplyr::filter(year > yrent) %>%
  dplyr::select(-ineffect, yrexit) %>%
  dplyr::mutate(atop_duration = year - yrent) %>%
  dplyr::select(ccode, year, atop_duration) %>%
  dplyr::group_by(ccode, year) %>%
  dplyr::summarise(atop_lengthmax = max(atop_duration),
                   atop_lengthavg = round(mean(atop_duration), 0),
                   .groups = "keep")
```

# Save
```{r}
write.csv(df, paste0(here::here(), "/data/","alliance_duration.csv"))
```

# Alliance level variables to add
## Alliance institutionalization
These come from Leeds and Anac 2005
```{r}
atop_instit <- rio::import(paste0(here::here(), "/inst/extdata/ATOP/atopinst5_0.csv"))


```

## Benson and Clinton
```{r}
benclin <- rio::import(paste0(here::here(), "/inst/extdata/Benson-Clinton_JCR_2014/AllianceDataScoreJCR_RR.csv"))
```



Get data on the formality of the alliance and peacetime military coorindation from ATOP webpage
