---
title: "Pre-Cleaned IISS Visualizations"
author: "J Andres Gannon"
date: "03/24/18"
output:
  html_notebook:
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
  html_document:
    toc: yes
editor_options:
  chunk_output_type: inline
---
<style>
    body .main-container {
        max-width: 100%;
    }
</style>

# Load Library
```{r , results='hide', message=FALSE, warning=FALSE, include=FALSE}
# Reset workspace
rm(list = ls())

# Memory saver
gc()

# Load essential packages
library(magrittr)
library(ggplot2)
library(data.table)
library(DescTools)

# Source functions
source(paste0(here::here(), "/R/missingness_df.R"))
source(paste0(here::here(), "/R/parentchild.R"))
source(paste0(here::here(), "/R/equip_domain.R"))
source(paste0(here::here(), "/R/country_year_equip_df.R"))
source(paste0(here::here(), "/R/iiss_wrangling_function.R"))

# Aesthetics
knitr::opts_knit$set(progress = TRUE, verbose = TRUE)
knitr::opts_chunk$set(fig.width = 12, fig.height = 8, warning = FALSE, message = FALSE, cache = TRUE)
options(width = 160)
```

# Load google sheet of raw data for cleaning and diagnostics
00_LoadData.Rmd converts the by-country .xlsx files into one .rds file.
```{r}
# Load .rds file
iiss <- readRDS(file = paste0(here::here(), '/data/01a_load.rds'))
```

################################ Year
# Checks for empty year rows
```{r}
iiss$year <- as.numeric(iiss$year)
class(iiss$year)

sum(is.na(iiss$year))
missing_years <- dplyr::filter(iiss, is.na(year)) %>% dplyr::distinct(country, year)

if(iiss$year > 2019 | iiss$year < 1970){
  print("Error: Year outside of range.")
  print(dplyr::filter(iiss, year > 2019 | year < 1970))
} else {
  print("All years in range.")
}

nrow(iiss)
plyr::count(iiss, "year")

ggplot(iiss, aes(x = year)) + # will not run if subset of only one year.
  geom_histogram(color="black", fill="grey", bins = (max(iiss$year, na.rm = TRUE) - min(iiss$year, na.rm = TRUE))) +
  scale_x_continuous(breaks= scales::pretty_breaks(n = 30)) +
  theme(axis.text.x = element_text(angle = 45))
```

################################ Pre-Cleaning Summary Statistics
# Summary stats to show data coverage and missingness
```{r}
# Show missing values
DataExplorer::plot_missing(iiss)
```

```{r}
# Show categorical frequency of discrete variables
DataExplorer::plot_bar(iiss)
```

```{r}
# Show distribution of continuous variables
DataExplorer::plot_histogram(iiss)
```

```{r}
# Missingness plot for technologies
iiss_tek <- googlesheets4::read_sheet('1yf-dGAiicIGNScouedvOCET4s34GGl3OelXrgOPWq8g', sheet = "iiss_platforms")

ggplot2::ggplot(iiss_tek, aes(x = year)) +
  geom_line(aes(y = iiss_platform_abbrev), size = 2) +
  scale_x_continuous(breaks = seq(1960, 2017, by = 5)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.y = element_blank()) +
  labs(title = "IISS Technology Observations per Year", x = "Year", y = "Tek", yShowTickLabel = FALSE)
```

```{r}
# Missingness plot for countries
iiss_country <- googlesheets4::read_sheet('1yf-dGAiicIGNScouedvOCET4s34GGl3OelXrgOPWq8g', sheet = "iiss_countries")

# Basic
ggplot2::ggplot(iiss_country, aes(x = year)) +
  geom_line(aes(y = ccode_name), size = 2) +
  scale_x_continuous(breaks = seq(1960, 2017, by = 5)) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), axis.text.y = element_blank()) +
  labs(title = "IISS Country Observations per Year", x = "Year", y = "Country", yShowTickLabel = FALSE)

# Country data missingness plot
missingness <- missingness_df()

Country <- missingness$country
Year <- missingness$year
Value <- missingness$value

ggplot2::ggplot(missingness, aes(Year, Country)) +
  geom_tile(aes(fill = Value), colour = "grey50") +
  scale_fill_manual(values=c("#000000","#FFFFFF", "#98F5FF", "#00008B"),
                    labels = c("-1 - non-existent entity","0 - COW state without IISS data","1 - COW state with IISS data","2 - COW stated with coded IISS data")) +
  theme(axis.text.x = element_text(angle = 90,vjust = 0.5),
        axis.text.y = element_blank()) +
  labs(y="",title = "Missingness")
```

```{r}
# countries to complete
unfinished <- missingness %>%
  dplyr::filter((value == 1)
                & year %in% c(1991:2014)
                ) %>%
  dplyr::distinct(country, year) 
unfinished$continent <- countrycode::countrycode(unfinished$country, 'country.name', 'continent')

unfinished_final <- unfinished %>% 
  dplyr::group_by(continent) %>% 
  dplyr::arrange(continent, country) %>% 
  dplyr::group_by(country) %>% 
  dplyr::filter(year == max(year)) %>% 
  dplyr::mutate(continent = tidyr::replace_na(continent, "Europe")) %>% 
  as.data.frame()

write.csv(x = unfinished_final, file = paste0(here::here(), "/R/cleaning/unfinished_country_years.csv"))

total_unfin <- nrow(unfinished)
total_coders <- total_unfin/7
as.Date("2020-04-27") - Today() 
total_coders_days <- total_coders/9
```

```{r}
# cow states not in IISS
cow_states <- countrycode::countrycode(states::cowstates$country_name, "country.name", "country.name")
iiss_states <- unique(countrycode::countrycode(iiss$country, "country.name", "country.name"))
cow_not_in_iiss <- setdiff(cow_states, iiss_states)
cow_not_in_iiss
```

################################ Service/Sub-Service/Subsub-Service
# Fixes manual coding errors in the services columns
```{r}
# Get unique service branches by  country
unique_services_by_country <- iiss %>%
  dplyr::group_by(country, year) %>%
  dplyr::distinct(service, subservice, subsubservice)

# Get unique mappings of services, subservices, and subsubservices by country
levels_countryyear <- c("country", "service", "subservice", "subsubservice")

# Example
us_2014 <- iiss[ which(iiss$country=='us'), ]
us_2014 <- us_2014[levels_countryyear]
tektree_us_2014 <- parentchild(us_2014)[[1]]
networkD3::diagonalNetwork(tektree_us_2014, fontSize = 14)

# Function
service_trees <- function(my_country, my_year){
  iiss$country <- as.character(iiss$country)
  x <- iiss[which(iiss$country == my_country & iiss$year == my_year), ]
  y <- x[levels_countryyear]
  z <- parentchild(y)[[1]]
  out <- networkD3::diagonalNetwork(z, fontSize = 14)
  print(out)
  #networkD3::saveNetwork(out, file = paste0(here::here(), "/R/cleaning/", my_country, "_", my_year, "_network"), selfcontained = TRUE)
}

service_trees("us", 2014)

# For loop
#for(i in unique(iiss$country)){
#  service_trees(i, 2014)
#}

# Reserve Frequency
reserve <- iiss %>%
  dplyr::group_by(country, year, service) %>%
  dplyr::summarize(service_count = dplyr::n(),
                   reserve_count = sum(stringr::str_detect(subservice, "reserve")),
                   perc = reserve_count/service_count * 100) %>%
  dplyr::filter(!is.na(perc) & perc != Inf & perc != 0)
ggplot(reserve, aes(x = year, y = perc, color = country)) +
  geom_jitter(alpha = .5, size = 3)
```
